---
output: 
  github_document:
    pandoc_args: "--webtex" #> Better maths rendering in Github https://github.com/rstudio/rmarkdown/issues/1886
    toc: true
    toc_depth: 4
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```

# BFSestimates

The goal of BFSestimates is to estimate the population, variance and confidence intervals from surveys conducted by *Bundesamt für Statistik* (BFS) / *Office fédéral de la statistique* (OFS):

- population survey (*Volkszählung* (VZ), *recensement de la population*),
- mobility and transport survey (*Mikrozensus Mobilität und Verkehr* (MZMV), *Microrecensement mobilité et transports* (MRMT)).

# Installation

You can install the development version of `BFSestimates` like so:

```{r eval = FALSE}
devtools::install_github("BFSestimates", "souadg")
```

# Usage

Population survey estimates:
```{r example1}
library(BFSestimates)
library(dplyr)
estimate_pop_cens(data = nhanes, 
                       weight_colname = "weights", 
                       strata_variable = "strata",
                       condition_col = "gender")
```

Mobility survey estimates:

# More Information

From the survey data, `BFestimates` estimates:

- occurrences in the real population: sum of weights of sub-population of interest (see Equation);
- variance $\hat V$ of the estimate; 
- standard deviation ($sd = \sqrt{\hat{V}}$) of the estimate;
- $95\%$ confidence interval of the estimate: $\pm 97.5^{\text{th}}$ centile of normal distribution with mean $0$ and standard deviation $\sqrt{\hat{V}}$;

## Population survey

The BFS/OFS provides [formulas to estimate populations and variances](https://portal.collab.admin.ch/sites/317-SE-CUG) in French (`do-f-40-se_METH.pdf`) and German(`do-d-40-se_METH.pdf`).

### Estimated Population (#estimated_pop)

The estimated populations from the population survey is given by:

$$\hat{N}_c = \sum_{i \in r} w_i I_c$$

where:

- $w_i$ the weight for participant $i$;
- $I_c = 1$ if condition(s) $c$ is true, 0 otherwise;
- $r$ is the set of participants

### Estimated Variance

The estimated variance is given by:
$$\hat{V}(\hat{N}_c) = \sum_h \frac{m_h}{m_h - 1}\left(1 - \frac{m_h}{N_h}\right) \sum_{i \in r_h}\left(w_i I_c - \frac{\hat{N}_{hc}}{m_h}\right)^2$$

where:

- $\hat{N}_c$ is the estimated occurrence of condition $c$;
- $h$ designates a stratum (e.g. `zone`)
- $\hat{N}_{hc}$ is the estimated occurrence of coditions $c$ in stratum $h$;
- $N_h$ is the total estimated population in stratum $h$ (sum of weights in stratum h);
- $r_h$ is the set of participants in stratum $h$;
- $m_h$ is the number of participants in stratum $h$.

Note that the second summation is over the whole stratum, so for condition $c$ this becomes:
$$
\begin{aligned}
\sum_{i \in r_h}\left(w_i I_c - \frac{\hat{N}_{hc}}{m_h}\right)^2 &=
\sum_{i \notin r_{hc}} \left(\frac{\hat{N}_{hc}}{m_h}\right)^2 + \sum_{i \in r_{hc}} \left(w_i - \frac{\hat{N}_{hc}}{m_h}\right)^2 \\
&= \left(m_h - m_{hc}\right) \left(\frac{\hat{N}_{hc}}{m_h}\right)^2  + \sum_{i \in r_{hc}} \left(w_i - \frac{\hat{N}_{hc}}{m_h}\right)^2
\end{aligned}
$$
where $r_{hc}$ is the set of respondents in stratum $h$ who fulfill condition $c$ and $m_{hc}$ the number of respondents in $r_{hc}$.

Finally the original variance estimate equation becomes:

$$\hat{V}(\hat{N}_c) = \sum_h \frac{m_h}{m_h - 1}\left(1 - \frac{m_h}{N_h}\right) \left[(m_h - m_{hc}) \left(\frac{\hat{N}_{hc}}{m_h}\right)^2  + \sum_{i \in r_{hc}} \left(w_i - \frac{\hat{N}_{hc}}{m_h}\right)^2\right]$$

`summarise_pop()` calculates $m_h, N_h, m_{hc}, \text{and } \hat{N}_{hc}$. 

`estimate_pop_cens()` implements the variance equation for $\hat{V}(\hat{N}_c)$ and calculates true occurrence in the survey sample and confidence intervals.

## Mobility and Transport Survey


